---
title: "Anàlisi de dades òmiques (M0-157). PAC1."
author: "Marc Anton"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introducció

Aquest arxiu conté les sol·lucions als problemes plantejats en la PAC1 *Anàlisi de dades òmiques (M0-157)*. El projecte total del treball es pot consultar al: meu repositori github, cliqueu **[aquí](https://github.com/MarcAnton1968/Anton_Recasens_Marc_PAC1/tree/master)**

# 2. Carrega de dades

A continuació, procedeixo a resoldre la PAC. Abans que res, carreguem les dades al nostre entorn de treball. Treballarem amb l'exemple de mostra, veure **[aquí](https://github.com/nutrimetabolomics/metaboData/tree/main/Datasets/2018-MetabotypingPaper)**. Carreguem els dos fitxers:

```{r}
DataInfo_S013 <- read.csv("DataInfo_S013.csv", sep = ",")
DataValues_S013 <- read.csv("DataValues_S013.csv", sep = ",")
```

Com que ja sabem que aquests fitxers solen portar molts camps, mirem primer l'estructura dels dos.

# 3. Eploració previa de les dades descarregades

```{r}
dim(DataInfo_S013)
dim(DataValues_S013)
```

Aqui ja veiem que en l'arxiu Values tenim 696 columnes, el que correspon a un index únic de cada cas d'estudi més les 695 variables que es tenen de cada un d'ells. Per veure que hi ha, mirem les 20 primeres files d'Info i podem fer-nos una idea

```{r}
head(DataInfo_S013,20)
```

Aqui ja veiem que hi ha 9 primers camps que semblen ser els que tenen la informació sobre el pacient mostra. Mirem que contenen aquests camps a values:

```{r}
# En mirem 10 en realitat, per comprovar que la primera columna és un index
head(DataValues_S013[,1:10])
```

Com suposavem, aquestes columnes corresponen a:
1. Un codi de pacient (que està repetit a les dues primeres columnes)
2. La cirugia a la que va ser sotmés el pacient
3. L'edat i el gènere
4. Un grup de tractament
5. 4 tractaments que venen amb 0 i 1

Per veure que la resta són metabolits, mirem 5 columnes més

```{r}
head(DataValues_S013[,11:15],10)
```

Obviament ja ho veiem i també podem veure que hi ha més d'un valor que no es té (NA)

# 4. Generació de l'obsject SummarizedExperiment

Ara que ja sabem que tenim a les dades, podem procedir a carregar-les en un objecte *SummarizedExperiment*. Per a fer-ho, convertirem però les dades a un data frame i li traurem la primera columna que ja hem vist que és redundant amb la segona. Aleshores ja ho podem carregar. En concret, carregarem:

1. L'arxiu DataVAlues com a assays que és on es guarden les dades de les mostres que tenim
2. L'arxiu DataInfo com a colData que és on es guarda la informació de com és cada columna d'assays.

```{r}
# Primer carreguem la llibreria per poder tractar el SummarizedExperiment
library(SummarizedExperiment)
# Primer eliminem la primera columna de DataValues i ho guardem com un data frame que és el que accepta SummarizedExperiment
DataValues_S013_matrix <- DataValues_S013[,-1]
# Ara ja podem carregar el SummarizedExperiment
seMA <- SummarizedExperiment(assays = list(counts = DataValues_S013_matrix),
                             colData = DataInfo_S013)
seMA
```

Sembla que l'objecte s'ha generat correctament

Mirem un parell de funcions que es poden fer. 

```{r}
# Comprovem com es diuen les columnes que tenim en cada una de les classes de dins de l'objecte
dimnames(seMA)
# I ara mirem les 10 primeres columnes i les 5 primeres files d'assays
assay(seMA)[1:5, 1:10]
# I també mirem com ha quedat colData
colData(seMA)
```

# 5. Anàlisi exploratoria de les dades

Com que el joc de dades que hé triat conté 395 camps i es fa molt dificil fer un anàlisi complet, provem a fer una cosa una  mica més ajustada i agafaré només les dades de descripció del casos analitzats i alguns metabolits. En concret em pararé en el ferro. és a dir que agafaré les primeres 40 columnes. En un context real s'hauria de fer amb tot i l'anàlisi seria molt llarg i tediós. 

Per tant, comencem per fer un subset del nostre SummarizedExperiment i el guardem com un data frame per poder treballar amb ell.

```{r}
analisi <- seMA[,1:40]
analisi
```

Ara, per tant, tenim un segon SummarizedExperiment que és un subset del primer. Conté nomnés les dades d'identificació de tots els pacients (columnes 1-9) i els primers 31 metabolits que es van recollir

## 5.1. Estadistics bàsics

Amb aixó, podem mirar una mica el que tenim

```{r}
str(assay(analisi))
summary(assay(analisi))
```

Ja només amb aquesta primera mirada, podem comprovar que les dades tenen una enorme variabilitat de rangs el que pot portar algun problema a l'hora de fer anàlisi més adelantats i que calgui escalar les variables en alguns casos

## 5.2. Analisi univariant

Ho fem amb histogrames. Farem 9 de les variables per veure una mica com es distribueixen

```{r}
opt <- par(mfrow=c(3,3))
for (i in 12:20)
  hist(assay(analisi)[,i], xlab = colData(analisi)[i,2], main = colData(analisi)[i,2])
par(opt)
```


## 5.3. Analisi de correlacions

Ho fariem amb plot. Un exemple

```{r}
# Mirem per  exemple, si l'edat es correlaciona be amb alguns
plot(assay(analisi)[,c(3,11:15)])
```

Una altra opció pot ser un heatmap de la matriu de correlacions que permetria veure totes les relacions 


```{r}
cor_matrix <- cor(na.omit(assay(analisi)[,c(3,12:40)]))
heatmap(cor_matrix)
```

Un altre heatmap que calcula distancies

```{r}
dist_matrix <- t(assay(analisi)[,c(3,12:40)])
heatmap(dist_matrix, col=heat.colors(16))
```



# 5.4. Components principals

Primer hem d'eliminar els NA i despres  podem. Cal fer-ho amb les columnes de metabolits (11-40)

```{r}
PCAMA <- prcomp(na.omit(assay(analisi)[,c(3,12:40)]), scale. = TRUE)
PCAMA
summary(PCAMA)
```

Les dues primeres components expliquen el 74% de la variancia i les 3 primres, el 93%. Grafiquem les dues primeres

```{r}
loads <- round(PCAMA$sdev^2/sum(PCAMA$sdev^2)*100,1)
groupColors <- c(rep("red", 4), rep("blue", 4))
xlab <- c(paste("PC1",loads[1],"%"))
ylab <- c(paste("PC2",loads[2],"%"))
plot(PCAMA$x[,1:2],
     xlab=xlab,
     ylab=ylab, 
     col=groupColors, 
     main ="Principal components (PCA)")
filesSenseNA <- complete.cases(assay(analisi)[,c(3,12:40)]) 
names2plot <- which(filesSenseNA) 

text(PCAMA$x[,1],PCAMA$x[,2],names2plot, pos=3, cex=.6)
```


