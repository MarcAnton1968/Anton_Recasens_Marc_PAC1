---
title: "Anàlisi de dades òmiques (M0-157). PAC1."
author: "Marc Anton"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introducció

Aquest arxiu conté les sol·lucions analítiques als problemes plantejats en la PAC1 *Anàlisi de dades òmiques (M0-157)*. El projecte total del treball es pot consultar al: meu repositori github, cliqueu **[aquí](https://github.com/MarcAnton1968/Anton_Recasens_Marc_PAC1/tree/master)**

# 2. Carrega de dades

Abans que res, carreguem les dades al nostre entorn de treball. Treballarem amb un dels exemples de mostra, veure **[aquí](https://github.com/nutrimetabolomics/metaboData/tree/main/Datasets/2018-MetabotypingPaper)**. Aquest exemple porta dos arxius, DataInfo_S013 i DataValues_S013. Carreguem els dos fitxers:

```{r}
DataInfo_S013 <- read.csv("DataInfo_S013.csv", sep = ",")
DataValues_S013 <- read.csv("DataValues_S013.csv", sep = ",")
```

Com és habitual amb dades òmiques, tenim moltes varibales i un nombre reduït de casos d'estudi. Tot i així, abans que res mirem l'estructura dels dos.

# 3. Eploració previa de les dades descarregades

```{r}
dim(DataInfo_S013)
dim(DataValues_S013)
```

Aqui ja veiem que en l'arxiu Info hi ha 695 files que han de correspondre a les variables que hi ha a Values. En aquest darrer tenim 696 columnes i 39 files. Les files corresponen a cada cas d'estudi més les 695 columnes són les variables que es tenen de cada un d'ells.

Per veure què són les variables, mirem les 20 primeres files d'Info i podem fer-nos una idea.

```{r}
head(DataInfo_S013,20)
```

Aqui ja veiem que hi ha 9 primers camps que semblen ser els que tenen la informació sobre el pacient de cada mostra. Mirem que contenen aquests camps a values:

```{r}
# En mirem 10 en realitat, per comprovar que la primera columna és un index
head(DataValues_S013[,1:10])
```

Com suposavem, aquestes columnes corresponen a:
1. Un codi de pacient (que està repetit a les dues primeres columnes, d'aquí que hi hagi una fila més a Info que columnes a Values)
2. La cirugia a la que va ser sotmés el pacient
3. L'edat i el gènere
4. Un grup de tractament
5. 4 tractaments que venen amb 0 i 1

Per veure que la resta són variables metabòliques, mirem 10 columnes més

```{r}
head(DataValues_S013[,11:20],10)
```

Obviament ja ho veiem i també podem veure que hi ha més d'un valor que no es té per a alguna de les variables (NA). Anem a veure si n'hi ha molts

```{r}
sum(is.na(DataValues_S013))/(dim(DataValues_S013)[1]*dim(DataValues_S013)[2])
```

Això apunta a que tenim un 12,5% de valors desconeguts. Aquest és un aspecte que caldrà tenir en compte en els anàlisi posteriors

# 4. Generació de l'obsject SummarizedExperiment

Ara que ja sabem que tenim a les dades, podem procedir a carregar-les en un objecte *SummarizedExperiment*. Per a fer-ho, convertirem però les dades a un data frame i li traurem la primera columna que ja hem vist que és redundant amb la segona. Aleshores ja ho podem carregar. En concret, carregarem:

1. Les dades de les  9 primeres columnes (obviant la primera que esta duplicada) de DataVAlues corresponen a dades dels pacients que els guardarem com a rowData ja que no formen part de l'anàlisi dels metabolits
2. La resta de dades de DataValues seràn els assays que és on es guarden les dades de les mostres que tenim
2. L'arxiu DataInfo com a colData que és on es guarda la informació de com és cada columna d'assays. D'aquí només hem d'agafar la part corresponent als metabolits. És a dir de la fila 11 endavant.

```{r}
# Primer carreguem la llibreria per poder tractar el SummarizedExperiment
library(SummarizedExperiment)

# Després generem les dades de pacients i de metabolits i la llista de rownames que volem tal i com hem indicat al text
pacients <- DataValues_S013[,2:10]
metabolits <- DataValues_S013[,11:696]
colNames <- DataInfo_S013[10:695,]
# Ara ja podem carregar el SummarizedExperiment
seMA <- SummarizedExperiment(assays = list(counts = as.matrix(metabolits)),
                             colData = colNames,
                             rowData = pacients)
seMA
```

Sembla que l'objecte s'ha generat correctament

Mirem un parell de funcions que es poden fer. 

```{r}
# Comprovem com es diuen les columnes que tenim en cada una de les classes de dins de l'objecte
dimnames(seMA)
# I ara mirem les 10 primeres columnes i les 5 primeres files d'assays
assay(seMA)[1:5, 1:10]
# I també mirem com ha quedat colData
colData(seMA)
# I les dades bàsiques dels pacients
rowData(seMA)

```


# 5. Anàlisi exploratoria inicial de les dades

## 5.1. Descripció de les dades

Fins ara hem vist que les nostres dades tenen NA, el que pot suposar un problema. Anem a veure també si la variabilitat de rangs és molt gran´i ens cal normalitzar les dades. Fem un summary a més per veure com varien els estadístics bàsics. Si ho fem amb tot l'arxiu no s'arriba a apreciar la sortida, així que en fem uns quants

```{r}
summary(assay(seMA)[,1:150])
```

Veiem que la variabilitat en els rangs és molt elevada i, per tant, caldrà normalitzar les dades. Recordem també que tenim un nombre de NAs força elevat.

ANEM PER AQUI

## 5.2. Preprocessat

Aqui ja en tenim prou per veure el mateix. Per tant, ens calen dos procesos per poder començar els anàlisi multivariants:

1. Imputar els missing values 
2. Normalitzar les dades

Això ho podem fer amb POMA que al mateix temps ens permet fer algun boxplot

```{r}
# primer instal·lem el paquet i les llibreries
# BiocManager::install("POMA") # Això només el primer cop per instal·lar el paquet
library(POMA)
library(ggtext)
library(magrittr)
```
Ataquem primer la imputació

```{r}
imputed <- sep1 %>% 
  PomaImpute(method = "mean", zeros_as_na = TRUE, remove_na = TRUE, cutoff = 20)
```

```{r}
for (i in 1:684)
  if (sum(is.na(assay(sep1)[,i])) > 25)
  {print((paste(i, sum(is.na(assay(sep1)[,i])))))}
```

sda


```{r}
normalized <- seMA %>% 
  PomaNorm(method = "log_pareto")
```



## 5.2. Analisi univariant

Ho fem amb histogrames. Farem 9 de les variables per veure una mica com es distribueixen

```{r}
opt <- par(mfrow=c(3,3))
for (i in 12:20)
  hist(assay(analisi)[,i], xlab = colData(analisi)[i,2], main = colData(analisi)[i,2])
par(opt)
```

--- NOTA: Fer algun boxplot

## 5.3. Analisi de correlacions

NOTA --- Potser de distancies???

Ho fariem amb plot. Un exemple

```{r}
# Mirem per  exemple, si l'edat es correlaciona be amb alguns
plot(assay(analisi)[,c(3,11:15)])
```

Una altra opció pot ser un heatmap de la matriu de correlacions que permetria veure totes les relacions 


```{r}
cor_matrix <- cor(na.omit(assay(seMA)[,c(3,12:40)]))
heatmap(cor_matrix)
```

Un altre heatmap que calcula distancies

```{r}
dist_matrix <- t(assay(analisi)[,c(3,12:40)])
heatmap(dist_matrix, col=heat.colors(16))
```



# 5.4. Components principals

Primer hem d'eliminar els NA i despres  podem. Cal fer-ho amb les columnes de metabolits (11-40)

```{r}
PCAMA <- prcomp(na.omit(assay(analisi)[,c(3,12:40)]), scale. = TRUE)
PCAMA
summary(PCAMA)
```

Les dues primeres components expliquen el 74% de la variancia i les 3 primres, el 93%. Grafiquem les dues primeres

```{r}
loads <- round(PCAMA$sdev^2/sum(PCAMA$sdev^2)*100,1)
groupColors <- c(rep("red", 4), rep("blue", 4))
xlab <- c(paste("PC1",loads[1],"%"))
ylab <- c(paste("PC2",loads[2],"%"))
plot(PCAMA$x[,1:2],
     xlab=xlab,
     ylab=ylab, 
     col=groupColors, 
     main ="Principal components (PCA)")
filesSenseNA <- complete.cases(assay(analisi)[,c(3,12:40)]) 
names2plot <- which(filesSenseNA) 

text(PCAMA$x[,1],PCAMA$x[,2],names2plot, pos=3, cex=.6)
```


